<view class="page-container">
  <!-- åŠ å…¥æˆ¿é—´å¼¹çª— -->
  <view xhs:if="{{showJoinModal}}" class="modal-mask" bindtap="closeJoinModal">
    <view class="modal-content join-modal" catchtap="preventClose">
      <text class="modal-title">åŠ å…¥Bingoæ¸¸æˆ</text>
      <text class="modal-desc">è¯·è¾“å…¥æˆ¿é—´å·å¼€å§‹æ¸¸æˆ</text>
      
      <view class="input-group">
        <text class="input-label">æˆ¿é—´å·</text>
        <input 
          class="room-input" 
          type="text" 
          placeholder="è¯·è¾“å…¥4ä½æˆ¿é—´å·" 
          value="{{inputRoomCode}}"
          bindinput="onRoomCodeInput"
          maxlength="4">
        </input>
      </view>
      
      <!-- å¯ç‚¹å‡»æ—¶å•ç‹¬æ¸²æŸ“ï¼Œä¸å¸¦ disabled å±æ€§ï¼Œé¿å…æ¡†æ¶æŠŠ disabled="false" ä»å½“ç¦ç”¨ -->
      <button 
        xhs:if="{{canJoin && !isLoading}}"
        class="btn-primary join-btn join-btn-enabled" 
        bindtap="handleJoinRoom">
        å¼€å§‹æ¸¸æˆ
      </button>
      <button 
        xhs:elif="{{!canJoin}}"
        class="btn-primary join-btn join-btn-disabled" 
        disabled
        bindtap="handleJoinRoom">
        å¼€å§‹æ¸¸æˆ
      </button>
      <button 
        xhs:else
        class="btn-primary join-btn join-btn-loading" 
        disabled>
        åŠ å…¥ä¸­...
      </button>
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view xhs:if="{{isLoading && hasJoined}}" class="loading-container">
    <view class="loading-icon"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <view xhs:elif="{{hasJoined}}">
    <!-- å‚ä¸è€…åˆ—è¡¨ -->
    <view class="participants-section">
      <view class="participants-list">
        <view 
          xhs:for="{{participants}}" 
          xhs:key="user_id"
          class="participant-item {{item.user_id === targetId ? 'active' : ''}}"
          bindtap="onParticipantSelect"
          data-user-id="{{item.user_id}}">
          <image 
            class="participant-avatar" 
            src="{{item.user.avatar || '/pages/assets/avatar/' + (item.user.mbti_type || 'default').toLowerCase() + '.png'}}" 
            mode="aspectFill">
          </image>
          <text class="participant-name">{{item.user.nickname || 'ç”¨æˆ·' + item.user_id}}</text>
        </view>
      </view>
    </view>

    <!-- Bingoæ¸¸æˆåŒºåŸŸ -->
    <view xhs:if="{{targetParticipant}}" class="game-card">
      <!-- æ ‡é¢˜æ  -->
      <view class="game-header mbti-{{targetParticipant.user.mbti_type || 'default'}}">
        <view class="header-content">
          <text class="game-title">{{targetParticipant.user.nickname || 'ç”¨æˆ·' + targetId}}çš„Bingoæ¸¸æˆ</text>
          <text class="game-subtitle">äº”ä¸ªè¿æˆä¸€æ¡çº¿ï¼Œä½ å°±æ˜¯ä¸€åª {{mbtiIntro || 'åŠ è½½ä¸­...'}}</text>
        </view>
        <image 
          xhs:if="{{targetParticipant.user.mbti_type}}"
          class="header-avatar" 
          src="/pages/assets/avatar/{{targetParticipant.user.mbti_type.toLowerCase()}}.png" 
          mode="aspectFit">
        </image>
      </view>

      <!-- 5x5æ ¼å­ -->
      <view class="grid-container mbti-{{targetParticipant.user.mbti_type || 'default'}}">
        <view class="grid-wrapper">
          <view 
            xhs:for="{{gridCells}}" 
            xhs:for-index="idx"
            xhs:key="id"
            class="grid-cell {{item.evaluated_by_me ? 'evaluated' : ''}} score-{{item.score > 5 ? 5 : item.score}} {{highlightedCells.indexOf(item.position) !== -1 ? 'highlighted' : ''}}"
            bindtap="onCellTap"
            data-cell-id="{{item.id}}"
            data-evaluated-by-me="{{item.evaluated_by_me}}">
            <view class="cell-text">{{item.trait_text}}</view>
            <view class="cell-score">{{item.score}}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- æˆå°±åˆ—è¡¨ -->
    <view class="achievements-section">
      <view class="section-header">
        <text class="section-title">ğŸ† æˆå°± / Bingo</text>
        <text class="section-desc">å½“æŸè¡Œ/åˆ—/æ–œçº¿å…¨éƒ¨è¢«è¯„ä»·æ—¶è¾¾æˆ</text>
      </view>
      
      <view xhs:if="{{achievements.length === 0}}" class="empty-achievements">
        <text class="empty-text">æš‚æ— æˆå°±</text>
      </view>
      
      <view xhs:else class="achievements-list">
        <view 
          xhs:for="{{achievements}}" 
          xhs:key="id"
          class="achievement-item">
          <view class="achievement-icon">
            <!-- æ¨ªçº¿ -->
            <view xhs:if="{{item.achievement_type === 'row'}}" class="line-icon horizontal"></view>
            <!-- ç«–çº¿ -->
            <view xhs:elif="{{item.achievement_type === 'col'}}" class="line-icon vertical"></view>
            <!-- ä¸»å¯¹è§’çº¿ -->
            <view xhs:elif="{{item.achievement_type === 'diagonal' && item.line_index === 0}}" class="line-icon diagonal-main"></view>
            <!-- å‰¯å¯¹è§’çº¿ -->
            <view xhs:else class="line-icon diagonal-anti"></view>
          </view>
          <text class="achievement-text">{{item.achievement_type === 'row' ? 'æ¨ªçº¿ ç¬¬' + (item.line_index + 1) + 'è¡Œ' : (item.achievement_type === 'col' ? 'ç«–çº¿ ç¬¬' + (item.line_index + 1) + 'åˆ—' : (item.line_index === 0 ? 'ä¸»å¯¹è§’çº¿' : 'å‰¯å¯¹è§’çº¿'))}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="safe-area-bottom"></view>

  <!-- çƒŸèŠ±ç‰¹æ•ˆ -->
  <confetti show="{{showConfetti}}" bind:finished="onConfettiFinished"></confetti>
</view>
