<view class="page-container">
  <!-- 加载状态 -->
  <view xhs:if="{{isLoading}}" class="loading-container">
    <view class="loading-icon">⏳</view>
    <text class="loading-text">正在加载题目...</text>
  </view>

  <!-- 错误状态 -->
  <view xhs:elif="{{loadError}}" class="error-container">
    <view class="error-icon">⚠️</view>
    <text class="error-text">加载题目失败</text>
    <button class="btn-primary retry-btn" bindtap="loadQuestions">重试</button>
  </view>

  <!-- 正常内容：一屏 flex 布局 -->
  <view xhs:else class="test-content">
    <!-- 进度条 -->
    <view class="progress-section">
      <view class="progress-header">
        <text class="progress-text">第 {{currentIndex + 1}} / {{questions.length}} 题</text>
        <text class="progress-percent">{{progressPercent}}%</text>
      </view>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{progressPercent}}%"></view>
      </view>
    </view>

      <!-- 题目卡片 -->
    <view class="question-card">
      <view class="question-number">Q{{currentIndex + 1}}</view>
      <text class="question-text">{{currentQuestion.question}}</text>
      
      <!-- 题目配图（可选） -->
      <image xhs:if="{{currentQuestion.image}}" 
             class="question-image" 
             src="{{currentQuestion.image}}" 
             mode="aspectFill"></image>
    </view>

    <!-- 选项按钮：使用题目返回的 positive / negative 文案 -->
    <view class="options-section">
      <view class="option-card {{isPositiveSelected ? 'selected' : ''}}" bindtap="selectOption" data-value="positive">
        <view class="option-icon">A</view>
        <view class="option-content single-line">
          <text class="option-title">{{currentQuestion.positive || '选项A'}}</text>
        </view>
      </view>

      <view class="option-card {{isNegativeSelected ? 'selected' : ''}}" bindtap="selectOption" data-value="negative">
        <view class="option-icon">B</view>
        <view class="option-content single-line">
          <text class="option-title">{{currentQuestion.negative || '选项B'}}</text>
        </view>
      </view>
    </view>

    <!-- 导航按钮 -->
    <view class="nav-buttons" xhs:if="{{questions.length > 0}}">
      <button class="btn-ghost nav-btn {{currentIndex <= 0 ? 'disabled' : ''}}" 
              bindtap="prevQuestion" 
              hover-class="button-hover">
        上一题
      </button>
      <button xhs:if="{{!isAllAnswered}}" 
              class="btn-secondary nav-btn {{currentIndex >= questions.length - 1 ? 'disabled' : ''}}" 
              bindtap="nextQuestion"
              hover-class="button-hover">
        下一题
      </button>
      <button xhs:if="{{isAllAnswered}}" 
              class="btn-primary nav-btn" 
              bindtap="submitTest"
              hover-class="button-hover">
        提交测评
      </button>
    </view>

    <!-- 题目索引导航：平铺全部题号，不左右滑动 -->
    <view class="question-nav">
      <view class="question-nav-grid">
        <view xhs:for-items="{{questions}}" 
              xhs:for-item="q" 
              xhs:for-index="idx"
              xhs:key="*item"
              class="question-nav-item {{answers[idx] ? 'answered' : ''}} {{currentIndex === idx ? 'current' : ''}}"
              bindtap="jumpToQuestion"
              data-index="{{idx}}">
          {{idx + 1}}
        </view>
      </view>
    </view>

    <!-- 题目出处信息 -->
    <view class="source-card">
      <view class="source-header">
        <text class="source-title"></text>
      </view>
      <text class="source-text">本测试出自中科院心理所修订的MBTI-70题标准版本。测试基于迈尔斯-布里格斯类型指标（MBTI）理论，由中国科学院心理研究所的心理学工作者，在与美国东卡罗莱纳大学合作的基础上，对原版MBTI量表（如Form G、Form M）进行了本土化修订和简化。</text>
    </view>

    <!-- 退出提示弹窗 -->
    <view xhs:if="{{showExitModal}}" class="modal-mask" bindtap="hideExitModal">
      <view class="modal-content" catchtap="preventClose">
        <view class="modal-header">
          <text class="modal-title">确认退出？</text>
        </view>
        <view class="modal-body">
          <text class="modal-text">当前测评进度将会丢失，确定要退出吗？</text>
        </view>
        <view class="modal-footer">
          <button class="btn-ghost modal-btn" bindtap="hideExitModal">继续测评</button>
          <button class="btn-secondary modal-btn" bindtap="confirmExit">确认退出</button>
        </view>
      </view>
    </view>

    <!-- 底部安全区域 -->
    <view class="safe-area-bottom"></view>
  </view>
</view>
